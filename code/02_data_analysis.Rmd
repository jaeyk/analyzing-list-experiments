  ---
title: "Data analysis"
author: "Jae Yeon Kim"
output:
  pdf_document:
    toc: yes
  html_document:
    theme: united
    toc: yes
---

# Setup 

```{r}

pacman::p_load(
        tidyverse, # for the tidyverse framework
        ggpubr, # for arranging ggplots   
        patchwork, # for arranging ggplots
        ggthemes, # for fancy ggplot themes
        estimatr, # for fast estimation for design-based inference
        list, # statistical analysis of list experiments
        DACF, # for ceiling and or/floor data 
        MKinfer, # for inferential statistics
        nonpar, # for nonparametric inference
        here
)


library(makereproducible)

# Import custom functions

script_list <- list.files(paste0(here::here(), "/functions"),
  pattern = "*.r|*.R",
  full.names = TRUE
)

for (i in 1:length(script_list))
{
  source(script_list[[i]])
}

# for publication-friendly theme

theme_set(theme_pubr())
```

# Importing data

```{r}

# The processed data 
df <- read.csv(make_here("/home/jae/analyzing-list-experiments/processed_data/processed_survey.csv"))

```
  
# Testing design effect 

- Tested design effect using Bonferroni-corrected p-value. If this value is below alpha, you reject the null hypothesis of no design effect. If it is above alpha, you fail to reject the null.

- Direct bias: Above alpha. No design effect.
- Indirect bias: Above alpha. No design effect.

```{r}

test <- subset(df, treat == 1 | treat == 3)

test$treat_f <- ifelse(test$treat == 3, 1, 0)

data(affirm)
data(race)

test.value.affirm <- ict.test(test$indirect, test$treat_f, J = 3, gms = TRUE)

```

# Multivariate analysis 

## Without concerning floor and ceiling effects 

```{r}

test$age <- normalize(test$age)
test$income <- normalize(test$income)
  
ate.ideo.q1 <- ictreg(direct ~ ideo_con + ideo_lib + income + men + college + age, treat = "treat_f", 
                 J = 3, 
         data = test, 
         method = "ml")

ate.par.q1 <- ictreg(direct ~ party_con + party_lib + income + men + college + age, treat = "treat_f", 
                 J = 3, 
         data = test, 
         method = "ml")

ate.ideo.q2 <- ictreg(indirect ~ ideo_con + ideo_lib + income + men + college + age, treat = "treat_f", 
                 J = 3, 
         data = test, 
         method = "ml")

ate.par.q2 <- ictreg(indirect ~ party_con + party_lib + income + men + college + age, treat = "treat_f", 
                 J = 3, 
         data = test, 
         method = "ml") 

qd1 <- analyze_multi_ate(ate.par.q1) %>%
  party_label() +
  labs(title = "Direct bias", 
       subtitle = "Partisanship",
       tags = "A") 

qd2 <- analyze_multi_ate(ate.ideo.q1) %>%
  ideo_label() +
  labs(title = "", 
       subtitle = "Ideology",
       tags = "B")

qid1 <- analyze_multi_ate(ate.par.q2) %>%
  party_label() +
  labs(title = "Indirect bias", 
       subtitle = "Partisanship",
       tags = "C") 

qid2 <- analyze_multi_ate(ate.ideo.q2) %>%
  ideo_label() +
  labs(title = "", 
       subtitle = "Ideology",
       tags = "D")

qd1 / qd2 
ggsave(here("outputs", "multi_direct.png"))

qid1 / qid2
ggsave(here("outputs", "multi_indirect.png"))

ggarrange(qd1, qd2, qid1, qid2, common.legend = TRUE)
ggsave(here("outputs", "multi_combined.png"))

```

# Response distributions 

```{r}

df %>%
  select(direct, indirect, treat) %>%
  rename("Direct bias" = "direct",
         "Indirect bias" = "indirect") %>%
  mutate(treat = case_when(
         treat == "1" ~ "Control",
         treat == "2" ~ "Low-income S. Koreans",
         treat == "3" ~ "North Korean refugees",
         treat == "4" ~ "Korean Chinese migrants",
         treat == "5" ~ "Indonesian migrants")) %>%
  mutate(treat = fct_relevel(treat, c("Control", "Low-income S. Koreans", "North Korean refugees", "Korean Chinese migrants", "Indonesian migrants"))) %>%
  pivot_longer(cols = c("Direct bias", "Indirect bias"),
               names_to = "Type",
               values_to = "Value") %>%
  mutate(Value = as.numeric(Value)) %>%
  ggplot(aes(x = Value, col = treat)) +
    geom_density() +
    facet_grid(~Type) +
    labs(x = "Response",
         y = "Count",
         col = "Treatment condition") 

ggsave(here("outputs", "res_dist.png"))

```

# Average treatment effect (ATE)

- By random assignment, difference-in-means is an unbiased estimator of the average treatment effect.
- Still, there's a concern about sampling variability. I address that by conducting t-tests. Here, the null hypothesis the average treatment effect is 0.

## ATE outcomes

```{r}

# Save test results
ate.results <- diff_means_test(df) 

# Recode values 
ate.results$treat <- ate.results$treat %>%
  recode(t1 = "Low-income S. Koreans",
         t2 = "North Korean refugees",
         t3 = "Korean Chinese migrants",
         t4 = "Indonesian migrants")

# Tidy model outcomes 
ate.results
```
## Visualizing results 

```{r}

ate.results %>%
  ggplot(aes(x = fct_reorder(treat, diff), y = diff, ymin = diff - conf, ymax = diff + conf)) +
  geom_pointrange() +
  geom_hline(yintercept = c(0), linetype = "dotted") +
  coord_flip() + 
  labs(x = "", y = "Estimated ATE") +
  facet_wrap(~var)

ggsave(make_here("/home/jae/analyzing-list-experiments/outputs/ate_results_plot.png"))

````

```{r}
cate.results %>%
  ggplot(aes(x = fct_reorder(group, Estimate), y = Estimate, ymin = Estimate - 2*SE, ymax = Estimate + 2*SE)) +
  geom_pointrange() +
  geom_hline(yintercept = c(0), linetype = "dotted") +
  coord_flip() +
#  scale_color_manual(values = c("Direct bias" = "red", "Indirect bias" = "blue")) +
  labs(y = "Conditional estimated ATE",
       x = "") 

ggsave(make_here("/home/jae/analyzing-list-experiments/outputs/cate_comparison_plot.png"))

```