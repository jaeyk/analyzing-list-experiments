  ---
title: "Data analysis"
author: "Jae Yeon Kim"
output:
  pdf_document:
    toc: yes
  html_document:
    theme: united
    toc: yes
---

# Setup 

```{r}

pacman::p_load(
        tidyverse, # for the tidyverse framework
        ggpubr, # for arranging ggplots   
        ggthemes, # for fancy ggplot themes
        estimatr, # for fast estimation for design-based inference
        DACF, # for ceiling and or/floor data 
        MKinfer, # for inferential statistics
        nonpar, # for nonparametric inference
        here
)


library(makereproducible)

# Import custom functions

script_list <- list.files(paste0(here::here(), "/functions"),
  pattern = "*.r|*.R",
  full.names = TRUE
)

for (i in 1:length(script_list))
{
  source(script_list[[i]])
}

# for publication-friendly theme

theme_set(theme_pubr())
```

## 1. Importing data

```{r}

# The processed data 
df <- read.csv(make_here("/home/jae/analyzing-list-experiments/processed_data/processed_survey.csv"))

```
  
## 2. Testing ceiling and/or floor effect 

```{r}

df %>%
  gather(measures, responses, c(direct, indirect)) %>%
  ggplot(aes(x = responses)) +
    geom_density() +
    facet_grid(measures~treat) +    
    labs(x = "Responses", y = "Density")

```

# Average treatment effect (ATE)

- By random assignment, difference-in-means is an unbiased estimator of the average treatment effect.
- Still, there's a concern about sampling variability. I address that by conducting t-tests. Here, the null hypothesis the average treatment effect is 0.


## ATE outcomes

```{r}

# Save test results
ate.results <- diff_means_test(df) 

# Recode values 
ate.results$treat <- ate.results$treat %>%
  recode(t1 = "Low-income S. Koreans",
         t2 = "North Korean refugees",
         t3 = "Korean Chinese migrants",
         t4 = "Indonesian migrants")

# Tidy model ouutcomes 
ate.results

```

# Conditional ATE

## Subsetting

```{r}

conservatives <- df %>% filter(ideology <= 2)

moderates <- df %>% filter(ideology == 3)

liberals <- df %>% filter(ideology == 4 | ideology == 5)

undecided <- df %>% filter(ideology == 6)

```

## Conditional ATE outcomes

```{r}

cate.results <- bind_rows(
mutate(diff_means_test(conservatives), subgroup = "Conservatives"),
mutate(diff_means_test(moderates), subgroup = "Moderates"),
mutate(diff_means_test(liberals), subgroup = "Liberals"),
mutate(diff_means_test(undecided), subgroup = "Undecided")
)

# Recode values 
cate.results$treat <- cate.results$treat %>%
  recode(t1 = "Low-income S. Koreans",
         t2 = "North Korean refugees",
         t3 = "Korean Chinese migrants",
         t4 = "Indonesian migrants")

# Tidy model ouutcomes 
cate.results

```

# Bootstrapping  

## Recalculating CIs for CATE

```{r}

boot.cate.results <- bind_rows(
mutate(boot_dmt(conservatives), subgroup = "Conservatives"),
mutate(boot_dmt(moderates), subgroup = "Moderates"),
mutate(boot_dmt(liberals), subgroup = "Liberals"),
mutate(boot_dmt(undecided), subgroup = "Undecided")
)

# Recode values 
boot.cate.results$treat <- boot.cate.results$treat %>%
  recode(t1 = "Low-income S. Koreans",
         t2 = "North Korean refugees",
         t3 = "Korean Chinese migrants",
         t4 = "Indonesian migrants")

# Tidy model ouutcomes 
boot.cate.results

```

# Visualizing results 

```{r}

ate.results %>%
  ggplot(aes(x = fct_reorder(treat, diff), y = diff, ymin = diff - conf, ymax = diff + conf, col = var)) +
  geom_pointrange() +
  geom_hline(yintercept = c(0), linetype = "dotted") +
  coord_flip() + 
  scale_colour_manual(values = c("Direct bias" = "red", "Indirect bias" = "blue")) +
  labs(title = "Treatment effects",
  subtitle = " Direct bias: X group is stupid. \n Indirect bias: X group doesn't deserve support.",
  caption = "Source: Original mobile survey (N = 1464)",
  x = "Treatment status", y = "Estimated Average Treatment Effect",
  col = "Bias type") 

ggsave(make_here("/home/jae/analyzing-list-experiments/outputs/ate_results_plot.png"), width = 10)

no_boot_plot <- cate.results %>%
  ggplot(aes(x = fct_reorder(subgroup, diff), y = diff, ymin = diff - conf, ymax = diff + conf, col = var)) +
  geom_pointrange() +
  geom_hline(yintercept = c(0), linetype = "dotted") +
  coord_flip() +
  scale_colour_manual(values = c("Direct bias" = "red", "Indirect bias" = "blue")) +
  facet_wrap(~treat) +
  labs(title = "Heterogeneous treatment effects",
  subtitle = "Direct bias: X group is stupid. Indirect bias: X group doesn't deserve support.",
  caption = "Source: Original mobile survey (N = 1464)",
  x = "Conditions", y = "Conditional Estimated Average Treatment Effect",
  col = "Bias type") +
  ylim(c(-0.4, 1.2))

boot_plot <- boot.cate.results %>%
  ggplot(aes(x = fct_reorder(subgroup, diff), y = diff, ymin = diff - conf, ymax = diff + conf, col = var)) +
  geom_pointrange() +
  geom_hline(yintercept = c(0), linetype = "dotted") +
  coord_flip() +
  scale_colour_manual(values = c("Direct bias" = "red", "Indirect bias" = "blue")) +
  facet_wrap(~treat) +
  labs(title = "Heterogeneous treatment effects (with Bootstrapped CIs)",
  subtitle = "Direct bias: X group is stupid. Indirect bias: X group doesn't deserve support.",
  caption = "Source: Original mobile survey (N = 1464)",
  x = "Conditions", y = "Conditional Estimated Average Treatment Effect",
  col = "Bias type") +
  ylim(c(-0.4, 1.2))

ggarrange(no_boot_plot, boot_plot, common.legend = TRUE,
          ncol = 1, nrow = 2)

ggsave(make_here("/home/jae/analyzing-list-experiments/outputs/cate_comparison_plot.png"), width = 10, height = 10)
```