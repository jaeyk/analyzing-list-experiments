  ---
title: "Data analysis"
author: "Jae Yeon Kim"
output:
  pdf_document:
    toc: yes
  html_document:
    theme: united
    toc: yes
---

# Setup 

```{r}

pacman::p_load(
        tidyverse, # for the tidyverse framework
        ggpubr, # for arranging ggplots   
        ggthemes, # for fancy ggplot themes
        estimatr, # for fast estimation for design-based inference
        DACF, # for ceiling and or/floor data 
        MKinfer, # for inferential statistics
        nonpar, # for nonparametric inference
        here
)


library(makereproducible)

# Import custom functions

script_list <- list.files(paste0(here::here(), "/functions"),
  pattern = "*.r|*.R",
  full.names = TRUE
)

for (i in 1:length(script_list))
{
  source(script_list[[i]])
}

# for publication-friendly theme

theme_set(theme_pubr())
```

# Importing data

```{r}

# The processed data 
df <- read.csv(make_here("/home/jae/analyzing-list-experiments/processed_data/processed_survey.csv"))

```
  
# Testing ceiling and/or floor effect 

```{r}

df %>%
  gather(measures, responses, c(direct, indirect)) %>%
  ggplot(aes(x = responses)) +
    geom_density() +
    facet_grid(measures~treat) +    
    labs(x = "Responses", y = "Density")

```

# Average treatment effect (ATE)

- By random assignment, difference-in-means is an unbiased estimator of the average treatment effect.
- Still, there's a concern about sampling variability. I address that by conducting t-tests. Here, the null hypothesis the average treatment effect is 0.


## ATE outcomes

```{r}

# Save test results
ate.results <- diff_means_test(df) 

# Recode values 
ate.results$treat <- ate.results$treat %>%
  recode(t1 = "Low-income S. Koreans",
         t2 = "North Korean refugees",
         t3 = "Korean Chinese migrants",
         t4 = "Indonesian migrants")

# Tidy model outcomes 
ate.results

```

# Conditional ATE

## Subsetting

```{r}

conservatives <- df %>% filter(party_f == "Conservative Partisans")

liberals <- df %>% filter(party_f == "Liberal Partisans")

```

## Conditional ATE outcomes

```{r}

cate.results <- bind_rows(
mutate(diff_means_test(conservatives), subgroup = "Conservatives"),
mutate(diff_means_test(liberals), subgroup = "Liberals"),
)

# Recode values 
cate.results$treat <- cate.results$treat %>%
  recode(t1 = "Low-income S. Koreans",
         t2 = "North Korean refugees",
         t3 = "Korean Chinese migrants",
         t4 = "Indonesian migrants")

# Tidy model outcomes 
cate.results

```

# Bootstrapping  

## Recalculating CIs for CATE

```{r}

boot.cate.results <- bind_rows(
mutate(boot_dmt(conservatives), subgroup = "Conservatives"),
mutate(boot_dmt(liberals), subgroup = "Liberals")
)

# Recode values 
boot.cate.results$treat <- boot.cate.results$treat %>%
  recode(t1 = "Low-income S. Koreans",
         t2 = "North Korean refugees",
         t3 = "Korean Chinese migrants",
         t4 = "Indonesian migrants")

# Tidy model outcomes 
boot.cate.results

```

# Visualizing results 

```{r}

ate.results %>%
  ggplot(aes(x = fct_reorder(treat, diff), y = diff, ymin = diff - conf, ymax = diff + conf)) +
  geom_pointrange() +
  geom_hline(yintercept = c(0), linetype = "dotted") +
  coord_flip() + 
  labs(x = "", y = "Estimated ATE") +
  facet_wrap(~var)

ggsave(make_here("/home/jae/analyzing-list-experiments/outputs/ate_results_plot.png"))

````

```{r}
cate.results %>%
  ggplot(aes(x = fct_reorder(treat, diff), y = diff, ymin = diff - conf, ymax = diff + conf)) +
  geom_pointrange() +
  geom_hline(yintercept = c(0), linetype = "dotted") +
  coord_flip() +
#  scale_color_manual(values = c("Direct bias" = "red", "Indirect bias" = "blue")) +
  facet_grid(var~subgroup) +
  labs(y = "Conditional estimated ATE",
       x = "") 

ggsave(make_here("/home/jae/analyzing-list-experiments/outputs/cate_comparison_plot.png"))
```